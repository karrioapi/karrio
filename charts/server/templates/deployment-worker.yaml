{{- if .Values.worker.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mychart.fullname" . }}-worker
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.worker.replicas | default 1 }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "mychart.name" . }}-worker
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "mychart.name" . }}-worker
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: kv-sa
      containers:
        - name: worker
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}

          # Bypass the entrypoint to run only the worker
          command: ["/bin/bash", "-c"]
          args:
          - |
            ./worker
            
          env:
            - name: DATABASE_HOST
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_HOST  
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_URL 
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_URL
            - name: DATABASE_PORT
              value: "5432"
            - name: DATABASE_NAME
              value: "citus"
            - name: DATABASE_USERNAME
              value: "karriouser"
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_PASSWORD  # RAW (not URL-encoded)
            - name: DATABASE_OPTIONS
              value: "sslmode=require"


            # Ensure the web+worker combo mode is OFF in this pod
            - name: DETACHED_WORKER
              value: "False"

            # Prefer a single REDIS_URL with TLS (Azure Redis)
            - name: REDIS_USERNAME
              value: "default"
            - name: REDIS_HOST 
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: host
            - name: REDIS_PORT
              value: "6379"
                # secretKeyRef:
                #   name: redis-credentials
                #   key: port
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: password
           

            # DB/JWT/SECRET if the worker uses them
            - name: SECRET_KEY
              valueFrom: { secretKeyRef: { name: shipping-platform-secrets, key: SECRET_KEY } }
            - name: JWT_SECRET
              valueFrom: { secretKeyRef: { name: shipping-platform-secrets, key: JWT_SECRET } }

            # Extra env map
            {{- range $k, $v := .Values.worker.extraEnv }}
            - name: {{ $k }}
              value: {{ $v | quote }}
            {{- end }}

          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: "1"
              memory: 512Mi

          # If you rely on SecretProviderClass sync, mount the CSI volume to trigger it
          {{- if and .Values.csi.enabled .Values.csi.volumes }}
          volumeMounts:
            {{- range .Values.csi.volumes }}
            - name: {{ .name }}
              mountPath: {{ .mountPath | quote }}
              readOnly: {{ default true .readOnly }}
            {{- end }}
          {{- end }}

      {{- if and .Values.csi.enabled .Values.csi.volumes }}
      volumes:
        {{- range .Values.csi.volumes }}
        - name: {{ .name }}
          csi:
            driver: {{ default "secrets-store.csi.k8s.io" .driver | quote }}
            readOnly: {{ default true .readOnly }}
            volumeAttributes:
              secretProviderClass: {{ .secretProviderClass | quote }}
        {{- end }}
      {{- end }}
{{- end }}
