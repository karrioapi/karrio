apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mychart.fullname" . }}
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount | default 1 }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "mychart.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        {{- include "mychart.labels" . | nindent 8 }}
    spec:
      serviceAccountName: kv-sa
      containers:
        - name: app
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }} 
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: {{ .Values.port }}
          readinessProbe:
            tcpSocket:
              port: {{ .Values.port }}
            initialDelaySeconds: 100
            periodSeconds: 10
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            tcpSocket:
              port: {{ .Values.port }}
            initialDelaySeconds: 200
            periodSeconds: 20
            timeoutSeconds: 2
            failureThreshold: 3
          env:
            - name: DEBUG_MODE
              value: {{ .Values.debug | default "true" | toString | quote }}
            - name: USE_HTTPS
              value: "true"
            - name: DETACHED_WORKER
              value: "true"

            # {{- range $k, $v := .Values.extraEnv }}
            # - name: {{ $k }}
            #   value: {{ $v | quote }}
            # {{- end }}

            # Secrets from synced K8s Secrets
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: shipping-platform-secrets
                  key: SECRET_KEY
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: shipping-platform-secrets
                  key: JWT_SECRET
            - name: EMAIL_HOST_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: shipping-platform-secrets
                  key: EMAIL_HOST_PASSWORD

            # Database
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_URL
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_USER
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: karrio-postgres
                  key: DATABASE_PASSWORD

            # Redis (or switch to REDIS_URL if your app supports it)
            - name: REDIS_HOST 
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: host
            - name: REDIS_PORT
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: port
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: password
            # - name: REDIS_URL
            #   valueFrom:
            #     secretKeyRef:
            #       name: redis-credentials
            #       key: connection-string


          {{- if and .Values.csi.enabled .Values.csi.volumes }}
          volumeMounts:
            {{- range .Values.csi.volumes }}
            - name: {{ .name }}
              mountPath: {{ .mountPath | quote }}
              readOnly: {{ default true .readOnly }}
            {{- end }}
           {{- end }}
      {{- if and .Values.csi.enabled .Values.csi.volumes }}
      volumes:
        {{- range .Values.csi.volumes }}
        - name: {{ .name }}
          csi:
            driver: {{ default "secrets-store.csi.k8s.io" .driver | quote }}
            readOnly: {{ default true .readOnly }}
            volumeAttributes:
              secretProviderClass: {{ .secretProviderClass | quote }}
        {{- end }}
      {{- end }}


# redineee prob 


# m4E8xv%40%2BeFAf)%3AC%40f87%25%24wl7%3C%3E%7B1%5D%3C%3Fj

# postgres://karriouser:m4E8xv%40%2BeFAf)%3AC%40f87%25%24wl7%3C%3E%7B1%5D%3C%3Fj@c-jtl-stg-westeurope-karrio-cosmos-postgres.ofdund3by2ok4z.postgres.cosmos.azure.com:5432/citus?sslmode=require