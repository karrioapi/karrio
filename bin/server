#!/usr/bin/env bash

# Activate python env
source "bin/activate-env" >/dev/null 2>&1

# Function to download GraphQL schema using curl and introspection
download_graphql_schema() {
    local endpoint="$1"
    local output_file="$2"

    echo "Downloading GraphQL schema from $endpoint..."

    curl -s -X POST "$endpoint" \
        -H "Content-Type: application/json" \
        -d '{
            "query": "query IntrospectionQuery { __schema { queryType { name } mutationType { name } subscriptionType { name } types { ...FullType } directives { name description locations args { ...InputValue } } } } fragment FullType on __Type { kind name description fields(includeDeprecated: true) { name description args { ...InputValue } type { ...TypeRef } isDeprecated deprecationReason } inputFields { ...InputValue } interfaces { ...TypeRef } enumValues(includeDeprecated: true) { name description isDeprecated deprecationReason } possibleTypes { ...TypeRef } } fragment InputValue on __InputValue { name description type { ...TypeRef } defaultValue } fragment TypeRef on __Type { kind name ofType { kind name ofType { kind name ofType { kind name ofType { kind name ofType { kind name ofType { kind name ofType { kind name } } } } } } } }"
        }' \
        -o "$output_file" && echo "✓ Schema saved to $output_file" || { echo "✗ Failed to download schema"; exit 1; }
}

# Run server commands
if [[ "$*" == *gen:ee* ]]; then
    cd "${ROOT:?}"
    download_graphql_schema "http://localhost:5002/graphql/" "${ROOT:?}/schemas/graphql-ee.json"
    cd -
elif [[ "$*" == *gen:graph* ]]; then
    cd "${ROOT:?}"
    download_graphql_schema "http://localhost:5002/graphql/" "${ROOT:?}/schemas/graphql.json"
    cd -
elif [[ "$*" == *gen:admin* ]]; then
    cd "${ROOT:?}"
    download_graphql_schema "http://localhost:5002/admin/graphql/" "${ROOT:?}/schemas/graphql-admin.json"
    cd -
elif [[ "$*" == *gen:platform* ]]; then
    cd "${ROOT:?}"
    download_graphql_schema "http://localhost:5002/admin/graphql/" "${ROOT:?}/ee/platform/schemas/graphql-platform.json"
    cd -
elif [[ "$*" == *gen:openapi* ]]; then
    cd "${ROOT:?}"
    curl http://localhost:5002/shipping-openapi -o "${ROOT:?}/schemas/openapi.yml"
    cd -
elif [[ "$*" == *gen:ref* ]]; then
    cd "${ROOT:?}"
    curl -s http://localhost:5002/v1/carriers -o "${ROOT:?}/apps/web/public/carrier-integrations.json" && \
        echo "✓ Carrier integrations saved to apps/web/public/carrier-integrations.json" || \
        { echo "✗ Failed to download carrier integrations"; exit 1; }
    # Copy to schemas directory
    cp "${ROOT:?}/apps/web/public/carrier-integrations.json" "${ROOT:?}/schemas/carrier-integrations.json" && \
        echo "✓ Carrier integrations copied to schemas/carrier-integrations.json"
    cd -
elif [[ "$*" == *gen:ts:cli* ]]; then
    cd "${ROOT:?}"
    docker run --rm -v ${PWD}:/local openapitools/openapi-generator-cli generate \
        -i /local/schemas/openapi.yml \
        -g typescript-fetch \
        -o /local/packages/karriojs/api/generated \
        --additional-properties=typescriptThreePlus=true \
        --additional-properties=modelPropertyNaming=snake_case \
        --additional-properties=useSingleRequestParameter=true
    cd -
elif [[ "$*" == *gen:all* ]]; then
    cd "${ROOT:?}"
    echo "Generating all Karrio schemas..."
    echo ""
    mkdir -p schemas

    # Generate GraphQL schema
    echo "1/6 Generating GraphQL schema..."
    download_graphql_schema "http://localhost:5002/graphql/" "${ROOT:?}/schemas/graphql.json"
    echo ""

    # Generate Admin GraphQL schema
    echo "2/6 Generating Admin GraphQL schema..."
    download_graphql_schema "http://localhost:5002/admin/graphql/" "${ROOT:?}/schemas/graphql-admin.json"
    echo ""

    # Generate EE GraphQL schema
    echo "3/6 Generating EE GraphQL schema..."
    download_graphql_schema "http://localhost:5002/graphql/" "${ROOT:?}/schemas/graphql-ee.json"
    echo ""

    # Generate Platform GraphQL schema
    echo "4/6 Generating Platform GraphQL schema..."
    download_graphql_schema "http://localhost:5002/admin/graphql/" "${ROOT:?}/ee/platform/schemas/graphql-platform.json"
    echo ""

    # Generate OpenAPI schema
    echo "5/6 Generating OpenAPI schema..."
    curl -s http://localhost:5002/shipping-openapi -o "${ROOT:?}/schemas/openapi.yml" && \
        echo "✓ OpenAPI schema saved to schemas/openapi.yml" || \
        echo "✗ Failed to download OpenAPI schema"
    echo ""

    # Generate carrier integrations reference
    echo "6/6 Generating carrier integrations reference..."
    curl -s http://localhost:5002/v1/carriers -o "${ROOT:?}/apps/web/public/carrier-integrations.json" && \
        echo "✓ Carrier integrations saved to apps/web/public/carrier-integrations.json" || \
        echo "✗ Failed to download carrier integrations"
    # Copy to schemas directory
    cp "${ROOT:?}/apps/web/public/carrier-integrations.json" "${ROOT:?}/schemas/carrier-integrations.json" && \
        echo "✓ Carrier integrations copied to schemas/carrier-integrations.json"
    echo ""

    echo "✓ All schemas generated successfully!"
    cd -
elif [[ "$*" == *build:elements* ]]; then
    cd "${ROOT:?}/packages/elements"

    # Build embeddable elements
    npm install
    npm run build || exit 1

    # Copy HTML shells into dist so they sit next to JS/CSS
    cp static/ratesheet.html dist/ratesheet.html
    cp static/devtools.html dist/devtools.html
    cp static/template-editor.html dist/template-editor.html
    cp static/connections.html dist/connections.html

    # Copy elements to Django static
    ELEMENTS_STATIC="${ROOT:?}/apps/api/karrio/server/static/karrio/elements"
    mkdir -p "${ELEMENTS_STATIC}"
    cp dist/elements.js "${ELEMENTS_STATIC}/elements.js"
    cp dist/globals.css "${ELEMENTS_STATIC}/globals.css"
    cp dist/ratesheet.js "${ELEMENTS_STATIC}/ratesheet.js"
    cp dist/ratesheet.html "${ELEMENTS_STATIC}/ratesheet.html"
    cp dist/devtools.js "${ELEMENTS_STATIC}/devtools.js"
    cp dist/devtools.css "${ELEMENTS_STATIC}/devtools.css"
    cp dist/devtools.html "${ELEMENTS_STATIC}/devtools.html"
    cp dist/template-editor.js "${ELEMENTS_STATIC}/template-editor.js"
    cp dist/template-editor.html "${ELEMENTS_STATIC}/template-editor.html"
    cp dist/connections.js "${ELEMENTS_STATIC}/connections.js"
    cp dist/connections.html "${ELEMENTS_STATIC}/connections.html"
    # Copy shared chunks
    if [ -d dist/chunks ]; then
      mkdir -p "${ELEMENTS_STATIC}/chunks"
      cp dist/chunks/* "${ELEMENTS_STATIC}/chunks/"
    fi

    echo "✓ Elements built and copied to ${ELEMENTS_STATIC}"
    cd -
    karrio collectstatic --noinput >/dev/null 2>&1
elif [[ "$*" == *build:js* ]]; then
    cd "${ROOT:?}/packages/karriojs"

    # Generate ts client
    . ${ROOT}/bin/server gen:ts:cli || exit 1

    # Build js client
    rm -rf node_modules
    npm install
    npx gulp build --output "${ROOT:?}/apps/api/karrio/server/static/karrio/js/karrio.js" || exit 1
    cd -
    karrio collectstatic --noinput >/dev/null 2>&1
else
    echo "Karrio Schema Generator"
    echo "======================"
    echo ""
    echo "Usage: ./bin/server <command>"
    echo ""
    echo "Available commands:"
    echo "  gen:ee        - Generate GraphQL enterprise edition schema from localhost:5002/graphql/"
    echo "  gen:graph     - Generate standard GraphQL schema from localhost:5002/graphql/"
    echo "  gen:admin     - Generate Admin GraphQL schema from localhost:5002/admin/graphql/"
    echo "  gen:platform  - Generate Platform GraphQL schema from localhost:5002/admin/graphql/"
    echo "  gen:openapi   - Generate OpenAPI schema from localhost:5002/shipping-openapi"
    echo "  gen:ref       - Generate carrier integrations reference file (saves to apps/web/public/, schemas/)"
    echo "  gen:all       - Generate all schemas (graphql, admin, ee, platform, openapi, carrier integrations)"
    echo "  gen:ts:cli    - Generate TypeScript fetch client from OpenAPI schema using docker"
    echo "  build:js      - Build Browser JavaScript client (runs gen:ts:cli, installs dependencies, builds with gulp)"
    echo "  build:elements - Build embeddable elements (rate sheet editor, devtools + host script) into Django static"
    echo ""
    echo "Examples:"
    echo "  ./bin/server gen:openapi"
    echo "  ./bin/server gen:all"
    echo ""
    echo "Output directories: schemas/, apps/web/public/"
    echo ""
    echo "Note: Make sure your development server is running on localhost:5002 before generating schemas."
fi
