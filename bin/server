#!/usr/bin/env bash

# Activate python env
source "bin/activate-env" > /dev/null 2>&1


# Run server commands
if [[ "$*" == *gen:graph* ]]; then
	cd "${ROOT:?}"
    npx apollo service:download --endpoint=http://0.0.0.0:5002/graphql/ "${ROOT:?}/schemas/graphql.json"
	cd -
elif [[ "$*" == *gen:openapi* ]]; then
	cd "${ROOT:?}"
    curl http://localhost:5002/shipping-openapi -o "${ROOT:?}/schemas/openapi.yml"
	cd -
elif [[ "$*" == *build:js* ]]; then
	cd "${ROOT:?}/.codegen/typescript"
	rm -rf node_modules;
    npm install;
	npx gulp build --output "${ROOT:?}/apps/api/karrio/server/static/karrio/js/karrio.js" || exit 1
	cd -
	karrio collectstatic --noinput
elif [[ "$*" == *build:pkgs* ]]; then
	cd "${ROOT:?}"
    rm -rf ${DIST}/*

    # Generate ts client
    . ${ROOT}/bin/server gen:ts:cli || exit 1

    # Build js client
    . ${ROOT}/bin/server build:js || exit 1

	cd -
else
    echo "Help: You can pass any the following commands to the server"
    echo "-----"
    echo "gen:graph - Generate GraphQL schema"
    echo "gen:openapi - Generate OpenAPI schema"
    echo "gen:js - Generate Javascript client"
    echo "build:pkgs - Build server packages"
fi
