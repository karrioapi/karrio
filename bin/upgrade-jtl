#!/usr/bin/env bash

set -e

echo "Upgrading JTL Shipping Platform. This will cause a few minutes of downtime."
read -r -p "Do you want to upgrade JTL Shipping Platform? [y/N] " response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
    echo "OK!"
else
    exit
fi

echo "Checking for named postgres volumes to avoid data loss when upgrading"
if docker volume ls | grep -e 'postgres-data'; then
    DOCKER_VOLUMES_MISSING=FALSE
    echo "Found postgres volume, proceeding..."
else
    DOCKER_VOLUMES_MISSING=TRUE
    echo ""
    echo ""
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ WARNING: POTENTIAL DATA LOSS ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo ""
    echo ""
    echo "We were unable to find named postgres volume."
    echo ""
    echo "WE STRONGLY RECOMMEND YOU:"
    echo ""
    echo "ğŸ›‘ Stop this script and do not proceed"
    echo "âœ… Back up your entire environment/installation (vm, host, etc.), including all docker containers and volumes:"
    echo "âœ… Specifically back up the contents of :"
    echo "  â˜‘ /var/lib/postgresql/data in the db (*_db_1) container"
    echo "and be ready to check/recopy the data before you boot JTL Shipping Platform next."
    read -r -p "Do you want to proceed anyway? [y/N] " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        echo "OK!"
    else
        exit
    fi
fi

# Load .env file to get GITHUB_TOKEN but preserve command-line JTL_TAG if set
CMDLINE_JTL_TAG="$JTL_TAG"
[[ -f ".env" ]] && export $(cat .env | grep -v '^#' | xargs) || (echo "No .env file found. Please create it with required variables." && exit 1)

# Verify GitHub credentials
if [ -z "$GITHUB_TOKEN" ]; then
    echo "GitHub token missing. Please ensure GITHUB_TOKEN is in your .env file"
    exit 1
fi

# Re-authenticate with GitHub
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# Get the default version from VERSION file in repository
# Command-line JTL_TAG takes precedence, otherwise fetch from repository
if [ -n "$CMDLINE_JTL_TAG" ]; then
    export JTL_TAG="$CMDLINE_JTL_TAG"
    echo "Using version from command line: $JTL_TAG"
else
    echo "Fetching latest version from repository..."
    DEFAULT_VERSION=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
         -H "Accept: application/vnd.github.v3.raw" \
         -L "https://api.github.com/repos/jtlshipping/shipping-platform/contents/VERSION?ref=main" | tr -d '[:space:]')
    export JTL_TAG="${DEFAULT_VERSION:-2025.5rc26}"
    echo "Using version: $JTL_TAG"
fi

# get jtl shipping platform scripts
mkdir -p ./jtl-deployment
cd jtl-deployment

echo "Downloading the latest JTL Shipping Platform installation files"
curl -H "Authorization: token $GITHUB_TOKEN" \
     -H "Accept: application/vnd.github.v3.raw" \
     -L "https://api.github.com/repos/jtlshipping/shipping-platform/contents/docker/docker-compose.yml?ref=main" \
     -o docker-compose.jtl.yml

cd -

# Upgrade Docker Compose to latest version if needed
echo "Checking Docker Compose version"
COMPOSE_VERSION=$(docker compose version --short 2>/dev/null || echo "0.0.0")
echo "Current Docker Compose version: $COMPOSE_VERSION"

rm -f docker-compose.yml
cp jtl-deployment/docker-compose.jtl.yml docker-compose.yml.tmpl
envsubst <docker-compose.yml.tmpl >docker-compose.yml
rm docker-compose.yml.tmpl

# Update .env file with new configuration
echo "Checking .env file for updates..."

# Function to add or update env variable
add_or_update_env() {
    local key="$1"
    local value="$2"
    local env_file=".env"

    if grep -q "^${key}=" "$env_file"; then
        echo "  âœ“ $key already exists"
    else
        echo "  + Adding $key"
        echo "$key=$value" >> "$env_file"
    fi
}

# Function to remove deprecated variable
remove_deprecated_env() {
    local key="$1"
    local env_file=".env"

    if grep -q "^${key}=" "$env_file"; then
        echo "  ğŸ—‘ï¸  Removing deprecated $key"
        sed -i.bak "/^${key}=/d" "$env_file"
    fi
}

# ========================================
# Migration: Remove Karrio OAuth variables
# ========================================
echo "ğŸ”„ Removing deprecated Karrio OAuth variables..."
remove_deprecated_env "OAUTH_CLIENT_ID"
remove_deprecated_env "OAUTH_CLIENT_SECRET"
remove_deprecated_env "VITE_KARRIO_OAUTH_CLIENT_ID"
remove_deprecated_env "VITE_KARRIO_OAUTH_CLIENT_SECRET"
remove_deprecated_env "VITE_KARRIO_OAUTH_REDIRECT_URI"

# ========================================
# Migration: Remove JTL API Gateway variables
# ========================================
echo "ğŸ”„ Removing deprecated JTL API Gateway variables..."
remove_deprecated_env "JTL_API_CLIENT_ID"
remove_deprecated_env "JTL_API_CLIENT_SECRET"
remove_deprecated_env "VITE_JTL_API_CLIENT_ID"
remove_deprecated_env "VITE_JTL_API_CLIENT_SECRET"

# ========================================
# Migration: Remove AppBridge/Session Token variables
# ========================================
echo "ğŸ”„ Removing deprecated AppBridge/session token variables..."
remove_deprecated_env "JTL_HUB_JWKS_URL"
remove_deprecated_env "JTL_HUB_ISSUER"
remove_deprecated_env "JTL_HUB_SSO_ENABLED"
remove_deprecated_env "JTL_HUB_AUTO_PROVISION_USERS"
remove_deprecated_env "JTL_HUB_AUTO_PROVISION_ORGS"

# ========================================
# Migration: JTL_CLIENT_ID â†’ JTL_HUB_CLIENT_ID
# ========================================
if grep -q "^JTL_CLIENT_ID=" ".env" && ! grep -q "^JTL_HUB_CLIENT_ID=" ".env"; then
    echo "  ğŸ”„ Migrating JTL_CLIENT_ID to JTL_HUB_CLIENT_ID"
    OLD_CLIENT_ID=$(grep "^JTL_CLIENT_ID=" ".env" | cut -d'=' -f2-)
    OLD_CLIENT_SECRET=$(grep "^JTL_CLIENT_SECRET=" ".env" | cut -d'=' -f2-)

    # Add new variable names with old values
    echo "JTL_HUB_CLIENT_ID=$OLD_CLIENT_ID" >> ".env"
    echo "JTL_HUB_CLIENT_SECRET=$OLD_CLIENT_SECRET" >> ".env"

    # Comment out old variable names (don't remove for safety)
    sed -i.bak 's/^JTL_CLIENT_ID=/#JTL_CLIENT_ID=/g' ".env"
    sed -i.bak 's/^JTL_CLIENT_SECRET=/#JTL_CLIENT_SECRET=/g' ".env"
fi

# ========================================
# Ensure JWT_SECRET exists
# ========================================
echo "âœ… Checking JWT configuration..."
if ! grep -q "^JWT_SECRET=" ".env"; then
    echo ""
    echo "âš ï¸  JWT_SECRET not found in your .env file."
    echo "This is required for JTL JWT authentication."
    echo ""
    read -r -p "Would you like to generate a new JWT_SECRET? [y/N] " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        JWT_SECRET=$(head -c 28 /dev/urandom | sha224sum -b | head -c 56)
        add_or_update_env "JWT_SECRET" "$JWT_SECRET"
        echo "  âœ“ Generated and added JWT_SECRET"
        echo ""
        echo "âš ï¸  IMPORTANT: Share this JWT_SECRET with JTL WAWI for authentication"
        echo "JWT_SECRET=$JWT_SECRET"
        echo ""
    else
        echo "  âš ï¸  Skipping JWT_SECRET generation."
        echo "  Please add JWT_SECRET manually to your .env file later."
    fi
fi

# ========================================
# Ensure Dashboard Test Mode Configuration
# ========================================
echo "âœ… Checking dashboard test mode configuration..."
if ! grep -q "^VITE_KARRIO_TEST_MODE=" ".env"; then
    echo ""
    echo "Configure default test mode for the dashboard:"
    echo "  â€¢ 'true'  = API requests default to test mode (recommended for testing)"
    echo "  â€¢ 'false' = API requests default to live mode (recommended for production)"
    echo ""
    read -r -p "Enable test mode by default? [y/N] " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        add_or_update_env "VITE_KARRIO_TEST_MODE" "true"
        echo "  âœ“ Test mode enabled by default"
    else
        add_or_update_env "VITE_KARRIO_TEST_MODE" "false"
        echo "  âœ“ Live mode enabled by default"
    fi
    echo ""
fi

# ========================================
# Ensure JTL Hub OAuth Configuration
# ========================================
echo "âœ… Checking JTL Hub OAuth configuration..."

# OAuth2 Endpoints
add_or_update_env "JTL_HUB_AUTHORIZE_URL" "https://auth.jtl-cloud.com/oauth2/auth"
add_or_update_env "JTL_HUB_TOKEN_URL" "https://auth.jtl-cloud.com/oauth2/token"

# Ensure JTL_HUB_CLIENT_ID exists
if ! grep -q "^JTL_HUB_CLIENT_ID=" ".env"; then
    echo "  âš ï¸  JTL_HUB_CLIENT_ID not found. Adding placeholder."
    echo "  ğŸ“ Replace with real credentials from https://developer.jtl-cloud.com"
    JTL_HUB_PLACEHOLDER_ID="placeholder-$(head -c 28 /dev/urandom | base64 | tr -d '/+=' | head -c 40)"
    add_or_update_env "JTL_HUB_CLIENT_ID" "$JTL_HUB_PLACEHOLDER_ID"
    add_or_update_env "JTL_HUB_CLIENT_SECRET" ""
fi

echo "âœ… Environment configuration updated"

# Reload .env with new variables
export $(cat .env | grep -v '^#' | xargs)

docker compose pull

echo "Stopping the stack!"
docker compose stop

# Patch existing Caddyfile to include X-Forwarded-Proto header if missing
if [[ -f "Caddyfile" ]]; then
    echo "Checking existing Caddyfile for HTTPS header forwarding..."
    TS="$(date +%Y%m%d_%H%M%S)"
    cp Caddyfile "Caddyfile.bak.${TS}" || true

    if ! grep -q "reverse_proxy http://api:5002 {" Caddyfile; then
        sed -i.bak "s|reverse_proxy http://api:5002$|reverse_proxy http://api:5002 {\\n        header_up X-Forwarded-Proto https\\n    }|" Caddyfile || true
    fi

    if ! grep -q "reverse_proxy http://dashboard:3102 {" Caddyfile; then
        sed -i.bak "s|reverse_proxy http://dashboard:3102$|reverse_proxy http://dashboard:3102 {\\n        header_up X-Forwarded-Proto https\\n    }|" Caddyfile || true
    fi

    echo "Caddyfile check complete. A backup was saved as Caddyfile.bak.${TS}"
fi

if [ ${DOCKER_VOLUMES_MISSING} == 'TRUE' ]; then
    echo ""
    echo ""
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨WARNING: LAST CHANCE TO AVOID DATA LOSS ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo ""
    echo ""
    echo "Before we restart the stack, you should restore data you have backed up from the previous warning."
    echo ""
    echo ""
fi

read -r -p "Do you want to restart the JTL Shipping Platform stack now ? (docker compose up) [y/N] " response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
    echo "OK, Restarting the stack!"
    sudo -E docker compose up -d
else
    echo "OK, we are leaving the stack OFFLINE. Run 'sudo -E docker compose up -d' when you are ready to start it."
    exit
fi

echo "JTL Shipping Platform upgraded successfully!"
echo ""

# Check if placeholder credentials are being used
if grep -q "^JTL_HUB_CLIENT_ID=placeholder-" ".env" 2>/dev/null; then
    echo "âš ï¸  IMPORTANT: JTL Hub OAuth Configuration"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Your deployment is using placeholder JTL Hub credentials."
    echo "To enable JTL Hub SSO authentication, you need to:"
    echo ""
    echo "1. Register your application at: https://developer.jtl-cloud.com"
    echo "2. Get your OAuth2 Client ID and Secret"
    echo "3. Update your .env file with:"
    echo "   JTL_HUB_CLIENT_ID=<your-client-id>"
    echo "   JTL_HUB_CLIENT_SECRET=<your-client-secret>"
    echo "4. Restart the dashboard: docker compose restart dashboard"
    echo ""
    echo "OAuth endpoints are already configured:"
    echo "  â€¢ Authorization: https://auth.jtl-cloud.com/oauth2/auth"
    echo "  â€¢ Token: https://auth.jtl-cloud.com/oauth2/token"
    echo ""
    echo "Redirect URI to register: ${DASHBOARD_URL}/auth/callback"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
fi
