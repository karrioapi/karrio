#!/usr/bin/env bash

set -e

echo "Upgrading JTL Shipping Platform. This will cause a few minutes of downtime."
read -r -p "Do you want to upgrade JTL Shipping Platform? [y/N] " response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
    echo "OK!"
else
    exit
fi

echo "Checking for named postgres volumes to avoid data loss when upgrading"
if docker volume ls | grep -e 'postgres-data'; then
    DOCKER_VOLUMES_MISSING=FALSE
    echo "Found postgres volume, proceeding..."
else
    DOCKER_VOLUMES_MISSING=TRUE
    echo ""
    echo ""
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ WARNING: POTENTIAL DATA LOSS ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo ""
    echo ""
    echo "We were unable to find named postgres volume."
    echo ""
    echo "WE STRONGLY RECOMMEND YOU:"
    echo ""
    echo "ğŸ›‘ Stop this script and do not proceed"
    echo "âœ… Back up your entire environment/installation (vm, host, etc.), including all docker containers and volumes:"
    echo "âœ… Specifically back up the contents of :"
    echo "  â˜‘ /var/lib/postgresql/data in the db (*_db_1) container"
    echo "and be ready to check/recopy the data before you boot JTL Shipping Platform next."
    read -r -p "Do you want to proceed anyway? [y/N] " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        echo "OK!"
    else
        exit
    fi
fi

# Load .env file to get GITHUB_TOKEN but preserve command-line JTL_TAG if set
CMDLINE_JTL_TAG="$JTL_TAG"
[[ -f ".env" ]] && export $(cat .env | xargs) || (echo "No .env file found. Please create it with required variables." && exit 1)

# Verify GitHub credentials
if [ -z "$GITHUB_TOKEN" ]; then
    echo "GitHub token missing. Please ensure GITHUB_TOKEN is in your .env file"
    exit 1
fi

# Re-authenticate with GitHub
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# Get the default version from VERSION file in repository
# Command-line JTL_TAG takes precedence, otherwise fetch from repository
if [ -n "$CMDLINE_JTL_TAG" ]; then
    export JTL_TAG="$CMDLINE_JTL_TAG"
    echo "Using version from command line: $JTL_TAG"
else
    echo "Fetching latest version from repository..."
    DEFAULT_VERSION=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
         -H "Accept: application/vnd.github.v3.raw" \
         -L "https://api.github.com/repos/jtlshipping/shipping-platform/contents/VERSION?ref=main" | tr -d '[:space:]')
    export JTL_TAG="${DEFAULT_VERSION:-2025.5rc25}"
    echo "Using version: $JTL_TAG"
fi

# get jtl shipping platform scripts
mkdir -p ./jtl-deployment
cd jtl-deployment

echo "Downloading the latest JTL Shipping Platform installation files"
curl -H "Authorization: token $GITHUB_TOKEN" \
     -H "Accept: application/vnd.github.v3.raw" \
     -L "https://api.github.com/repos/jtlshipping/shipping-platform/contents/docker/docker-compose.yml?ref=main" \
     -o docker-compose.jtl.yml

cd -

# Upgrade Docker Compose to latest version if needed
echo "Checking Docker Compose version"
COMPOSE_VERSION=$(docker compose version --short 2>/dev/null || echo "0.0.0")
echo "Current Docker Compose version: $COMPOSE_VERSION"

rm -f docker-compose.yml
cp jtl-deployment/docker-compose.jtl.yml docker-compose.yml.tmpl
envsubst <docker-compose.yml.tmpl >docker-compose.yml
rm docker-compose.yml.tmpl

docker compose pull

echo "Stopping the stack!"
docker compose stop

# Patch existing Caddyfile to include X-Forwarded-Proto header if missing
if [[ -f "Caddyfile" ]]; then
    echo "Checking existing Caddyfile for HTTPS header forwarding..."
    TS="$(date +%Y%m%d_%H%M%S)"
    cp Caddyfile "Caddyfile.bak.${TS}" || true

    if ! grep -q "reverse_proxy http://api:5002 {" Caddyfile; then
        sed -i.bak "s|reverse_proxy http://api:5002$|reverse_proxy http://api:5002 {\\n        header_up X-Forwarded-Proto https\\n    }|" Caddyfile || true
    fi

    if ! grep -q "reverse_proxy http://dashboard:3102 {" Caddyfile; then
        sed -i.bak "s|reverse_proxy http://dashboard:3102$|reverse_proxy http://dashboard:3102 {\\n        header_up X-Forwarded-Proto https\\n    }|" Caddyfile || true
    fi

    echo "Caddyfile check complete. A backup was saved as Caddyfile.bak.${TS}"
fi

if [ ${DOCKER_VOLUMES_MISSING} == 'TRUE' ]; then
    echo ""
    echo ""
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨WARNING: LAST CHANCE TO AVOID DATA LOSS ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo "ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨"
    echo ""
    echo ""
    echo "Before we restart the stack, you should restore data you have backed up from the previous warning."
    echo ""
    echo ""
fi

read -r -p "Do you want to restart the JTL Shipping Platform stack now ? (docker compose up) [y/N] " response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
    echo "OK, Restarting the stack!"
    sudo -E docker compose up -d
else
    echo "OK, we are leaving the stack OFFLINE. Run 'sudo -E docker compose up -d' when you are ready to start it."
    exit
fi

echo "JTL Shipping Platform upgraded successfully!"
