#!/usr/bin/env bash

set -e

# Get the default version from VERSION file
DEFAULT_VERSION=$(cat "$(dirname "$0")/../VERSION" 2>/dev/null || echo "2025.1.0")
export JTL_TAG="${JTL_TAG:-$DEFAULT_VERSION}"

SECRET_KEY=$(head -c 28 /dev/urandom | sha224sum -b | head -c 56)
JWT_SECRET=$(head -c 28 /dev/urandom | sha224sum -b | head -c 56)
export SECRET_KEY
export JWT_SECRET

# Talk to the user
echo "Welcome to JTL Shipping Platform installer"
echo ""
echo "âš ï¸  You really need 4gb or more of memory to run this stack âš ï¸"
echo ""
echo "ğŸ“– Deployment docs: https://github.com/jtlshipping/shipping-platform"
echo ""

# GitHub authentication for private images
if [ -z "$GITHUB_TOKEN" ]; then
    echo "Please enter your GitHub Personal Access Token (needs read:packages scope):"
    read -r GITHUB_TOKEN
    export GITHUB_TOKEN
fi

if ! [ -z "$1" ]; then
    export JTL_TAG=$1
else
    echo "What version of JTL Shipping Platform would you like to install? (We default to '${JTL_TAG}')"
    echo "You can check available versions at: https://github.com/jtlshipping/shipping-platform/pkgs/container/shipping-platform-server"
    read -r JTL_TAG_READ
    if [ -z "$JTL_TAG_READ" ]; then
        echo "Using default and installing $JTL_TAG"
    else
        export JTL_TAG=$JTL_TAG_READ
        echo "Using provided tag: $JTL_TAG"
    fi
fi

if ! [ -z "$2" ]; then
    export DOMAIN=$2
else
    echo "Let's get the exact domain JTL Shipping Platform will be installed on"
    echo "Make sure that you have Host A DNS records pointing to this instance!"
    echo "This will be used for TLS ğŸ”"
    echo "ie: jtl.example.com (NOT an IP address)"
    read -r DOMAIN
    export DOMAIN=$DOMAIN
fi

echo "Ok we'll set up certs for these subdomains: "
echo "- https://api.$DOMAIN"
echo "- https://app.$DOMAIN"
echo ""
echo "We will need sudo access so the next question is for you to give us superuser access"
echo "Please enter your sudo password now:"
sudo echo ""
echo "Thanks! ğŸ™"
echo ""
echo "Ok! We'll take it from here ğŸš€"

echo "Making sure any stack that might exist is stopped"
sudo -E docker compose -f docker-compose.yml stop &>/dev/null || true

# update apt cache
echo "Grabbing latest apt caches"
sudo apt update

# get jtl shipping platform deployment files
mkdir -p ./jtl-deployment
cd jtl-deployment

echo "Downloading JTL Shipping Platform installation files"
# In production, these files should be downloaded from your repository
# For now, we'll assume they're in the docker directory
cd -

if [ -n "$3" ]; then
    export TLS_BLOCK="acme_ca https://acme-staging-v02.api.letsencrypt.org/directory"
fi

# rewrite caddyfile
rm -f docker/Caddyfile
envsubst > docker/Caddyfile <<EOF
{
    http_port 80
    https_port 443
    $TLS_BLOCK
}
api.$DOMAIN {
    header Strict-Transport-Security max-age=31536000;
    header -Server
    handle_path /static/* {
        root * /var/www/karrio/static
        file_server {
            precompressed br gzip
        }
    }
    handle {
        reverse_proxy http://api:5002 {
            header_up X-Forwarded-Proto https
        }
    }
    encode gzip
    log {
        output stdout
    }
}
app.$DOMAIN {
    reverse_proxy http://dashboard:3102 {
        header_up X-Forwarded-Proto https
    }
}
EOF

# Export environment variables for envsubst
export DASHBOARD_URL=https://app.$DOMAIN
export KARRIO_PUBLIC_URL=https://api.$DOMAIN

# JTL Hub OAuth2 Credentials
# Get these from https://developer.jtl-cloud.com
if [ -z "$JTL_HUB_CLIENT_ID" ]; then
    echo "âš ï¸  JTL_HUB_CLIENT_ID not set. Generating placeholder (replace with real credentials)"
    echo "   Get real credentials from: https://developer.jtl-cloud.com"
    JTL_HUB_CLIENT_ID="placeholder-$(head -c 28 /dev/urandom | base64 | tr -d '/+=' | head -c 40)"
fi

# JTL Hub Client Secret (optional for PKCE flow)
if [ -z "$JTL_HUB_CLIENT_SECRET" ]; then
    echo "â„¹ï¸  JTL_HUB_CLIENT_SECRET not set (optional for public PKCE clients)"
    JTL_HUB_CLIENT_SECRET=""
fi

# Write .env file
cat > docker/.env <<EOF
# ============================================
# JTL Shipping Platform Configuration
# ============================================

# Domain Configuration
DOMAIN=$DOMAIN
DASHBOARD_URL=$DASHBOARD_URL
KARRIO_PUBLIC_URL=$KARRIO_PUBLIC_URL
JTL_TAG=$JTL_TAG
DASHBOARD_PORT=3102

# Security Keys
SECRET_KEY=$SECRET_KEY
JWT_SECRET=$JWT_SECRET
SENTRY_DSN=${SENTRY_DSN:-}

# ============================================
# JTL Hub Authentication
# ============================================

# OAuth2 Client Credentials (from https://developer.jtl-cloud.com)
JTL_HUB_CLIENT_ID=$JTL_HUB_CLIENT_ID
JTL_HUB_CLIENT_SECRET=$JTL_HUB_CLIENT_SECRET

# OAuth2 Endpoints (usually don't need to change)
JTL_HUB_AUTHORIZE_URL=https://auth.jtl-cloud.com/oauth2/auth
JTL_HUB_TOKEN_URL=https://auth.jtl-cloud.com/oauth2/token
EOF

# setup docker
echo "Setting up Docker"
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt-cache policy docker-ce
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# setup docker-compose (included with docker-ce)
echo "Docker Compose is included with Docker CE"

# enable docker without sudo
sudo usermod -aG docker "${USER}" || true

# login to docker private registry
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# start up the stack
echo "Configuring Docker Compose...."
echo "Starting the stack!"
cd docker
sudo -E docker compose up -d
cd -

echo "We will need to wait ~5-10 minutes for things to settle down, migrations to finish, and TLS certs to be issued"
echo ""
echo "â³ Waiting for JTL Shipping Platform api to boot (this will take a few minutes)"
bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' https://api.${DOMAIN})" != "200" ]]; do sleep 5; done'
echo "âŒ›ï¸ JTL Shipping Platform looks up!"
echo ""
echo "ğŸ‰ğŸ‰ğŸ‰  Done! ğŸ‰ğŸ‰ğŸ‰"
echo ""
echo "To stop the stack run 'cd docker && docker compose stop'"
echo "To start the stack again run 'cd docker && docker compose start'"
echo "If you have any issues at all delete everything in this directory and run the deployment script again"
echo ""
echo "JTL Shipping Platform will be up at the location you provided!"
echo "API:         https://api.${DOMAIN}"
echo "Dashboard:   https://app.${DOMAIN}"
echo ""
echo "This is the end: Happy shipping with JTL Shipping Platform!"
echo ""

# Check if placeholder credentials are being used
if grep -q "^JTL_HUB_CLIENT_ID=placeholder-" "docker/.env" 2>/dev/null; then
    echo "âš ï¸  IMPORTANT: JTL Hub OAuth Configuration"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Your deployment is using placeholder JTL Hub credentials."
    echo "To enable JTL Hub SSO authentication, you need to:"
    echo ""
    echo "1. Register your application at: https://developer.jtl-cloud.com"
    echo "2. Get your OAuth2 Client ID and Secret"
    echo "3. Update docker/.env file with:"
    echo "   JTL_HUB_CLIENT_ID=<your-client-id>"
    echo "   JTL_HUB_CLIENT_SECRET=<your-client-secret>"
    echo "4. Restart the dashboard: cd docker && docker compose restart dashboard"
    echo ""
    echo "OAuth endpoints are already configured:"
    echo "  â€¢ Authorization: https://auth.jtl-cloud.com/oauth2/auth"
    echo "  â€¢ Token: https://auth.jtl-cloud.com/oauth2/token"
    echo ""
    echo "Redirect URI to register: ${DASHBOARD_URL}/auth/callback"
    echo ""
    echo "For development/testing, you can also use Karrio API Token authentication"
    echo "from the sign-in page (API Token tab)."
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
fi
