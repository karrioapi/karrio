#!/bin/bash

export SECRET_KEY=${SECRET_KEY:="0/zfUEetNIle3iNekk4npo4T1pLFAWOyBFgbAu0afB4="}
export ADMIN_EMAIL=${ADMIN_EMAIL:="admin@example.com"}
export ADMIN_PASSWORD=${ADMIN_PASSWORD:="demo"}

# Setup DB and static files
karrio migrate || exit
karrio collectstatic --noinput 1>/dev/null || exit

# Setup Default super admin
(echo "
from decouple import config
from django.contrib.auth import get_user_model
if not any(get_user_model().objects.all()):
   ADMIN_EMAIL = config('ADMIN_EMAIL', default='admin@example.com')
   ADMIN_PASSWORD = config('ADMIN_PASSWORD', default='demo')
   get_user_model().objects.create_superuser(ADMIN_EMAIL, ADMIN_PASSWORD)
" | karrio shell) || exit

# Warn if background tasks will run synchronously
if [[ ! "${DETACHED_WORKER,,}" =~ ^(false|0|no|off)$ ]] && [ -z "$REDIS_HOST" ] && [ -z "$REDIS_URL" ]; then
    echo "WARNING: DETACHED_WORKER is enabled but no Redis is configured."
    echo "Background tasks (webhooks, events) will run synchronously in the web process."
fi

# Start services
if [[ "${DETACHED_WORKER,,}" =~ ^(false|0|no|off)$ ]]; then
    set -e # turn on bash's job control
    trap 'kill 0' INT

    gunicorn --config gunicorn-cfg.py karrio.server.asgi -k karrio.server.workers.UvicornWorker &
    /bin/bash ./worker &

    wait -n

else
    gunicorn --config gunicorn-cfg.py karrio.server.asgi -k karrio.server.workers.UvicornWorker
fi
